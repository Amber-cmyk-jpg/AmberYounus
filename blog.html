<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Posts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
}
.post-card {
  max-width: 420px;
  margin: 20px auto;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,.1);
}
.post-card img {
  width: 100%;
  height: 260px;
  object-fit: cover;
}
.post-body {
  padding: 12px;
}
</style>
</head>

<body>
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal">
        âž• Create Post
      </button>

      <select id="categoryFilter" class="form-select d-inline-block w-auto ms-2">
        <option value="">All Categories</option>
      </select>
    </div>

    <div>
      <span id="userEmail" class="me-2"></span>
      <button class="btn btn-outline-secondary" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="posts" class="d-flex flex-wrap justify-content-center"></div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Create Post</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="previewImage" class="img-fluid rounded mb-2"
             src="https://via.placeholder.com/400x250">

        <input type="file" id="imageInput" class="form-control mb-2" accept="image/*">
        <input id="titleInput" class="form-control mb-2" placeholder="Title" />
        <textarea id="contentInput" class="form-control mb-2" placeholder="Write your post..."></textarea>
        <input id="categoryInput" class="form-control mb-2" placeholder="Category (e.g. Technology)" />
      </div>

      <div class="modal-footer">
        <button id="createPostBtn" class="btn btn-success">Post</button>
      </div>

    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Edit Post</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="editPreview" class="img-fluid rounded mb-2">
        <input type="file" id="editInput" class="form-control mb-2" accept="image/*">
        <input id="titleEdit" class="form-control mb-2" placeholder="Title" />
        <textarea id="contentEdit" class="form-control mb-2" placeholder="Content..."></textarea>
        <input id="categoryEdit" class="form-control mb-2" placeholder="Category" />
      </div>

      <div class="modal-footer">
        <button id="saveImageBtn" class="btn btn-success">Save</button>
      </div>

    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

let currentUser;
let editingPostId = null;
let currentEditingPost = null;

/* ELEMENTS */
const imageInput = document.getElementById("imageInput");
const previewImage = document.getElementById("previewImage");
const titleInput = document.getElementById("titleInput");
const contentInput = document.getElementById("contentInput");
const categoryInput = document.getElementById("categoryInput");
const createPostBtn = document.getElementById("createPostBtn");
const postsDiv = document.getElementById("posts");
const categoryFilter = document.getElementById("categoryFilter");

const editModalEl = document.getElementById("editModal");
const editPreview = document.getElementById("editPreview");
const editInput = document.getElementById("editInput");
const saveImageBtn = document.getElementById("saveImageBtn");
const titleEdit = document.getElementById("titleEdit");
const contentEdit = document.getElementById("contentEdit");
const categoryEdit = document.getElementById("categoryEdit");
const createModalEl = document.getElementById("createModal");

/* INIT: CHECK LOGIN */
(async function () {
  const { data } = await supabase.auth.getUser();
  if (!data.user) return location.href = "auth.html";
  currentUser = data.user;
  document.getElementById('userEmail').innerText = currentUser.email;
  fetchPosts();
})();

/* PREVIEW IMAGE */
imageInput.addEventListener("change", e => {
  if (e.target.files[0]) {
    previewImage.src = URL.createObjectURL(e.target.files[0]);
  }
});

/* CREATE POST */
createPostBtn.addEventListener("click", async () => {
  const file = imageInput.files[0];
  const title = titleInput.value.trim();
  const content = contentInput.value.trim();
  const category = categoryInput.value.trim();

  if (!file || !title) return alert("Please provide a title and select an image.");

  const ext = file.name.split('.').pop();
  const path = `${currentUser.id}/${Date.now()}.${ext}`;

  // upload to storage
  const { error: uploadError } = await supabase.storage
    .from('posts')
    .upload(path, file);

  if (uploadError) return alert(uploadError.message);

  const { data } = supabase.storage.from('posts').getPublicUrl(path);

  // insert post
  const { error: insertError } = await supabase.from('posts').insert({
    user_id: currentUser.id,
    title,
    content,
    category,
    image_url: data.publicUrl,
    image_path: path
  });

  if (insertError) return alert(insertError.message);

  // reset form
  imageInput.value = "";
  titleInput.value = "";
  contentInput.value = "";
  categoryInput.value = "";
  previewImage.src = "https://via.placeholder.com/400x250";

  bootstrap.Modal.getInstance(createModalEl).hide();
  fetchPosts();
});

/* HELPER: derive storage path from public URL if needed */
function getPathFromUrl(url) {
  if (!url) return null;
  const parts = url.split('/posts/');
  return parts[1] ? decodeURIComponent(parts[1]) : null;
}

/* FETCH POSTS */
async function fetchPosts() {
  const { data, error } = await supabase
    .from('posts')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) return alert(error.message);

  // populate category filter
  const categories = Array.from(new Set(data.map(p => p.category).filter(Boolean)));
  categoryFilter.innerHTML = '<option value="">All Categories</option>' +
    categories.map(c => `<option value="${c}">${c}</option>`).join('');

  const selected = categoryFilter.value;
  const filtered = selected ? data.filter(p => p.category === selected) : data;

  postsDiv.innerHTML = "";

  filtered.forEach(post => {
    const isOwner = post.user_id === currentUser.id;
    postsDiv.innerHTML += `
      <div class="post-card m-2">
        <img src="${post.image_url}">
        <div class="post-body text-start">
          <h5>${post.title || ''}</h5>
          <small class="text-muted">${post.category ? post.category : ''} ${isOwner ? '(You)' : ''}</small>
          <p class="mt-2">${post.content || ''}</p>
          <div class="d-flex justify-content-between mt-2">
            ${isOwner ? `<div>
              <button class="btn btn-sm btn-outline-primary me-2" onclick="openEdit('${post.id}')">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePost('${post.id}')">Delete</button>
            </div>` : ''}
          </div>
        </div>
      </div>
    `;
  });
}

categoryFilter.addEventListener('change', fetchPosts);

/* OPEN EDIT MODAL */
window.openEdit = async (id) => {
  editingPostId = id;

  const { data: post, error } = await supabase.from('posts').select('*').eq('id', id).single();
  if (error) return alert(error.message);

  currentEditingPost = post;
  editPreview.src = post.image_url;
  titleEdit.value = post.title || '';
  contentEdit.value = post.content || '';
  categoryEdit.value = post.category || '';

  new bootstrap.Modal(editModalEl).show();
};

/* SAVE EDIT (image optional) */
saveImageBtn.addEventListener('click', async () => {
  const newFile = editInput.files[0];
  const updated = {
    title: titleEdit.value.trim(),
    content: contentEdit.value.trim(),
    category: categoryEdit.value.trim()
  };

  try {
    // if new image provided, upload and delete old
    if (newFile) {
      const ext = newFile.name.split('.').pop();
      const path = `${currentUser.id}/${Date.now()}-${newFile.name}`;
      const { error: uploadError } = await supabase.storage.from('posts').upload(path, newFile);
      if (uploadError) throw uploadError;

      const { data } = supabase.storage.from('posts').getPublicUrl(path);
      updated.image_url = data.publicUrl;
      updated.image_path = path;

      // delete old image if we have a path
      const oldPath = currentEditingPost.image_path || getPathFromUrl(currentEditingPost.image_url);
      if (oldPath) {
        await supabase.storage.from('posts').remove([oldPath]);
      }
    }

    const { error: updateError } = await supabase.from('posts').update(updated).eq('id', editingPostId);
    if (updateError) throw updateError;

    bootstrap.Modal.getInstance(editModalEl).hide();
    editInput.value = '';
    fetchPosts();
  } catch (err) {
    alert(err.message || 'Failed to update post');
  }
});

/* DELETE POST */
window.deletePost = async (id) => {
  if (!confirm('Are you sure you want to delete this post?')) return;

  try {
    const { data: post, error } = await supabase.from('posts').select('*').eq('id', id).single();
    if (error) throw error;

    const path = post.image_path || getPathFromUrl(post.image_url);
    if (path) {
      await supabase.storage.from('posts').remove([path]);
    }

    const { error: delError } = await supabase.from('posts').delete().eq('id', id);
    if (delError) throw delError;

    fetchPosts();
  } catch (err) {
    alert(err.message || 'Failed to delete post');
  }
};

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

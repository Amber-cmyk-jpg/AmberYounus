<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Posts</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
}
.post-card {
  max-width: 420px;
  margin: 20px auto;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,.1);
}
.post-card img {
  width: 100%;
  height: 260px;
  object-fit: cover;
}
.post-body {
  padding: 12px;
}
</style>
</head>

<body>
<div class="container py-4 text-center">

  <button class="btn btn-primary my-3" data-bs-toggle="modal" data-bs-target="#createModal">
    âž• Create Post
  </button>

  <div id="posts"></div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Create Post</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="previewImage" class="img-fluid rounded mb-2"
             src="https://via.placeholder.com/400x250">

        <input type="file" id="imageInput" class="form-control mb-2" accept="image/*">
        <textarea id="captionInput" class="form-control" placeholder="Caption..."></textarea>
      </div>

      <div class="modal-footer">
        <button id="createPostBtn" class="btn btn-success">Post</button>
      </div>

    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Edit Image</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="editPreview" class="img-fluid rounded mb-2">
        <input type="file" id="editInput" class="form-control" accept="image/*">
      </div>

      <div class="modal-footer">
        <button id="saveImageBtn" class="btn btn-success">Save</button>
      </div>

    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

let currentUser;
let editingPostId = null;

/* ELEMENTS */
const imageInput = document.getElementById("imageInput");
const previewImage = document.getElementById("previewImage");
const captionInput = document.getElementById("captionInput");
const createPostBtn = document.getElementById("createPostBtn");
const postsDiv = document.getElementById("posts");

const editModalEl = document.getElementById("editModal");
const editPreview = document.getElementById("editPreview");
const editInput = document.getElementById("editInput");
const saveImageBtn = document.getElementById("saveImageBtn");
const createModalEl = document.getElementById("createModal");

/* INIT: CHECK LOGIN */
(async function () {
  const { data } = await supabase.auth.getUser();
  if (!data.user) location.href = "auth.html";
  currentUser = data.user;
  fetchPosts();
})();

/* PREVIEW IMAGE */
imageInput.addEventListener("change", e => {
  if (e.target.files[0]) {
    previewImage.src = URL.createObjectURL(e.target.files[0]);
  }
});

/* CREATE POST */
createPostBtn.addEventListener("click", async () => {
  const file = imageInput.files[0];
  const caption = captionInput.value.trim();

  if (!file) return alert("Please select an image");

  const ext = file.name.split(".").pop();
  const path = `${currentUser.id}/${Date.now()}.${ext}`;

  // upload to storage
  const { error: uploadError } = await supabase.storage
    .from("posts")
    .upload(path, file);

  if (uploadError) return alert(uploadError.message);

  const { data } = supabase.storage.from("posts").getPublicUrl(path);

  // insert post
  const { error: insertError } = await supabase.from("posts").insert({
    user_id: currentUser.id,
    image_url: data.publicUrl,
    caption
  });

  if (insertError) return alert(insertError.message);

  // reset form
  imageInput.value = "";
  captionInput.value = "";
  previewImage.src = "https://via.placeholder.com/400x250";

  bootstrap.Modal.getInstance(createModalEl).hide();
  fetchPosts();
});

/* FETCH POSTS */
async function fetchPosts() {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) return alert(error.message);

  postsDiv.innerHTML = "";

  data.forEach(post => {
    postsDiv.innerHTML += `
      <div class="post-card">
        <img src="${post.image_url}">
        <div class="post-body">
          <p>${post.caption || ""}</p>
          <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-sm btn-outline-primary"
              onclick="openEdit('${post.id}','${post.image_url}')">
              Edit Image
            </button>
            <button class="btn btn-sm btn-outline-danger"
              onclick="deletePost('${post.id}')">
              Delete
            </button>
          </div>
        </div>
      </div>
    `;
  });
}


/* OPEN EDIT MODAL */
window.openEdit = (id, img) => {
  editingPostId = id;
  editPreview.src = img;
  new bootstrap.Modal(editModalEl).show();
};

/* SAVE EDIT IMAGE */
saveImageBtn.addEventListener("click", async () => {
  const file = editInput.files[0];
  if (!file) return alert("Select a file");

  const path = `${currentUser.id}/${Date.now()}-${file.name}`;

  const { error: uploadError } = await supabase.storage.from("posts").upload(path, file);
  if (uploadError) return alert(uploadError.message);

  const { data } = supabase.storage.from("posts").getPublicUrl(path);

  const { error: updateError } = await supabase.from("posts")
    .update({ image_url: data.publicUrl })
    .eq("id", editingPostId);

  if (updateError) return alert(updateError.message);

  bootstrap.Modal.getInstance(editModalEl).hide();
  editInput.value = "";
  fetchPosts();
});

/* DELETE POST */
window.deletePost = async (id) => {
  if (!confirm("Are you sure you want to delete this post?")) return;

  const { error } = await supabase
    .from("posts")
    .delete()
    .eq("id", id);

  if (error) return alert(error.message);

  fetchPosts(); // Refresh posts after deletion
};

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

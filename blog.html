<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Supabase Posts</title>
<meta http-equiv="Content-Security-Policy"
content="
  default-src 'self';
  connect-src 'self' http://127.0.0.1:5502 https://*.supabase.co;
  img-src 'self' data: https:;
  style-src 'self' 'unsafe-inline';
  script-src 'self' 'unsafe-inline';
">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
}
.post-card {
  max-width: 420px;
  margin: 20px auto;
  background: #fff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 25px rgba(0,0,0,.1);
}
.post-card img {
  width: 100%;
  height: 260px;
  object-fit: cover;
}
.post-body {
  padding: 12px;
}
</style>
</head>

<body>
<div class="container py-4 text-center">

  <button class="btn btn-primary my-3" data-bs-toggle="modal" data-bs-target="#createModal">
    âž• Create Post
  </button>

  <div id="posts"></div>
</div>

<!-- CREATE MODAL -->
<div class="modal fade" id="createModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Create Post</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="previewImage" class="img-fluid rounded mb-2"
             src="https://via.placeholder.com/400x250">

        <input type="file" id="imageInput" class="form-control mb-2" accept="image/*">
        <textarea id="captionInput" class="form-control" placeholder="Caption..."></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="createPost()">Post</button>
      </div>

    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="editModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5>Edit Image</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <img id="editPreview" class="img-fluid rounded mb-2">
        <input type="file" id="editInput" class="form-control" accept="image/*">
      </div>

      <div class="modal-footer">
        <button class="btn btn-success" onclick="saveImage()">Save</button>
      </div>

    </div>
  </div>
</div>

<script type="module">
import { supabase } from "./supabase.js";

let currentUser;
let editingPostId = null;

/* INIT */
(async function () {
  const { data } = await supabase.auth.getUser();
  if (!data.user) location.href = "auth.html";
  currentUser = data.user;
  fetchPosts();
})();

/* PREVIEW */
imageInput.onchange = e => {
  previewImage.src = URL.createObjectURL(e.target.files[0]);
};

/* CREATE POST */
createPost.onclick = async () => {
  const file = imageInput.files[0];
  const caption = captionInput.value.trim();

  if (!file) return alert("Please select an image");

  const ext = file.name.split(".").pop();
  const path = `${currentUser.id}/${Date.now()}.${ext}`;

  const { error } = await supabase.storage
    .from("posts")
    .upload(path, file);

  if (error) return alert(error.message);

  const { data } = supabase
    .storage
    .from("posts")
    .getPublicUrl(path);

  await supabase.from("posts").insert({
    user_id: currentUser.id,
    image_url: data.publicUrl,
    caption
  });

  imageInput.value = "";
  captionInput.value = "";
  

  bootstrap.Modal.getInstance(createModal).hide();
  fetchPosts();
}

/* FETCH POSTS */
async function fetchPosts() {
  const { data } = await supabase
    .from("posts")
    .select("*")
    .order("created_at", { ascending: false });

  posts.innerHTML = "";

  data.forEach(post => {
    posts.innerHTML += `
      <div class="post-card">
        <img src="${post.image_url}">
        <div class="post-body">
          <p>${post.caption || ""}</p>
          <button class="btn btn-sm btn-outline-primary"
            onclick="openEdit('${post.id}','${post.image_url}')">
            Edit Image
          </button>
        </div>
      </div>
    `;
  });
}

/* OPEN EDIT */
window.openEdit = (id, img) => {
  editingPostId = id;
  editPreview.src = img;
  new bootstrap.Modal(editModal).show();
};

/* SAVE EDIT */
window.saveImage = async () => {
  const file = editInput.files[0];
  if (!file) return;

  const path = `${currentUser.id}/${Date.now()}-${file.name}`;
  await supabase.storage.from("posts").upload(path, file);

  const { data } = supabase.storage.from("posts").getPublicUrl(path);

  await supabase.from("posts")
    .update({ image_url: data.publicUrl })
    .eq("id", editingPostId);

  bootstrap.Modal.getInstance(editModal).hide();
  fetchPosts();
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
